# Auth Service

**Auth-service** — микросервис, предоставляющий функционал авторизации и аутентификации на основе JWT-токенов (`access_token` и `refresh_token`). Сервис взаимодействует с клиентами исключительно через gRPC и включает набор методов для управления токенами и регистрацией пользователей.

## Основные функции

### 1. **GenerateToken**
Метод для получения JWT-токенов (`access_token` и `refresh_token`) по логину и паролю пользователя.

**Алгоритм работы:**
- Проверка, что поля `username` и `password` не пустые.
- Поиск пользователя в базе данных:
  - Если пользователь не найден — возвращается ошибка.
  - Если пользователь найден — генерируются токены.
- Возвращаются сгенерированные токены (не сохраняются в БД).

**Пример payload JWT-токена:**
```json
{
  "exp": 1733250150,
  "role": "user",
  "user_id": "b7d6599e-f43e-4ecf-be2d-cd81a8684b11",
  "username": "paul"
}
```
---

### 2. **ValidateToken**

Метод для проверки валидности `access_token`.

#### Алгоритм работы:
1. Проверяется, что `access_token` не пустой.
   - Если пустой — возвращается ошибка.
2. Выполняется валидация токена:
   - Если токен невалиден — возвращается ошибка.
   - Если токен валиден — возвращается статус `OK`.

#### Особенности:
- Данные о токене не записываются в базу данных.

---

### 3. **RefreshToken**

Метод для обновления токенов (`access_token` и `refresh_token`) с использованием `refresh_token`.

#### Алгоритм работы:
1. Проверяется, что `refresh_token` не пустой.
   - Если пустой — возвращается ошибка.
2. Выполняется валидация токена:
   - Если токен невалиден — возвращается ошибка.
   - Если токен валиден — из payload извлекается `user_id`.
3. Проверяется наличие пользователя в базе данных:
   - Если пользователь отсутствует — возвращается ошибка.
   - Если пользователь найден — генерируются новые токены.
4. Возвращаются новые токены (в базу данных они не сохраняются).

---

### 4. **RegisterUser** 

Метод для регистрации новых пользователей с указанием `username`, `password` и `email`.

#### Алгоритм работы:
1. Проверяется, что поля `username`, `password` и `email` не пустые.
   - Если пустые — возвращается ошибка.
2. Хэшируется пароль:
   - Если произошла ошибка — возвращается ошибка.
   - Если успешно — проверяется наличие пользователя с таким же `username` или `email` в базе данных.
3. Если пользователь уже существует — возвращается ошибка.
4. Создаётся новый пользователь в базе данных.
5. Возвращается уникальный идентификатор пользователя (`user_id`).

---

### 5. **RevokeToken** <b><font color="red">НЕ РЕАЛИЗОВАНО</font></b>

Метод для отзыва (аннулирования) токена `access_token` пользователя.

#### Алгоритм работы:
1. Проверяется, что `access_token` не пустой.
   - Если токен пустой — возвращается ошибка.
2. Выполняется валидация токена:
   - Если токен невалиден — возвращается ошибка.
   - Если токен валиден, извлекается информация из payload, включая дату истечения (`exp`).
3. Токен хэшируется для обеспечения безопасности.
4. Сохраняется хэшированное значение токена и дата истечения в таблице `revoked_tokens` в базе данных.
   - Если сохранение не удалось — возвращается ошибка.
5. Возвращается флаг успеха или неудачи.

---